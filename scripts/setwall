#!/bin/bash
#
# A wallpaper selector script for setting the wallpaper using swaybg
# and update the colorscheme using wallust

readonly WALLPAPERS="${WALLPAPERS:-$HOME/Pictures/Wallpapers}"

readonly WALLPAPER_PATH="$HOME/.cache/wallpaper"

# Send message to STDERR and as notification
err() {
  echo "$*" >&2
  notify-send -u critical "ï±  Error" "$*"
}

# Check for missing dependencies
check_dependencies() {
  declare -a missing_deps

  if ! command -v "nsxiv" &>/dev/null; then
    missing_deps+=("nsxiv")
  fi

  if ! command -v "swaybg" &>/dev/null; then
    missing_deps+=("swaybg")
  fi

  if [[ "${#missing_deps[@]}" -gt 0 ]]; then
    err "Missing dependencies: ${missing_deps[*]}"
    exit 1
  fi
}

restart_waybar() {
  pkill waybar
  waybar &>/dev/null &
  disown
}

update_colorscheme() {

  if ! command -v wallust &>/dev/null; then
    err "Wallust not found for updating the colorscheme"
    return 1
  fi

  if wallust run "$WALLPAPER_PATH" -q; then
    restart_waybar
  else
    err "Failed to update colorscheme with wallust"
    return 1
  fi
}

# Update wallpaper using swaybg
set_wallpaper() {
  local wallpaper="${1:?"Wallpaper path required"}"

  if [[ -f "$wallpaper" ]]; then
    # Resolve the absolute path
    local absolute_path
    absolute_path="$(realpath "$wallpaper")"

    ln -sf "$absolute_path" "$WALLPAPER_PATH"

    pkill dunst
    pkill swaybg
    swaybg -i "$WALLPAPER_PATH" -m fill &>/dev/null &
    disown

    update_colorscheme
  fi
}

main() {

  check_dependencies

  local wallpaper="$1"

  if [[ -f "$wallpaper" ]]; then
    set_wallpaper "$wallpaper"
    return 0
  fi

  # Ensure no other nsxiv instances are running
  if pgrep -x "nsxiv" >/dev/null; then
    exit 1
  fi

  # Ensure wallpapers directory exists
  if [[ ! -d "$WALLPAPERS" ]]; then
    err "Wallpapers directory does not exist: $WALLPAPERS"
  fi

  notify-send "Wallpaper Selector" "Press 'Q' to select"

  # Launch nsxiv to pick wallpaper
  wallpaper="$(nsxiv -b "$WALLPAPERS" -rot)"
  set_wallpaper "$wallpaper"

}

main "$@"
