#!/usr/bin/env bash

readonly ENTRY_HEIGHT=40
readonly INPUT_HEIGHT=44

declare -a connections

get_menu_dimensions() {
  local number_of_entries="$1"
  local size

  size="$((INPUT_HEIGHT + (ENTRY_HEIGHT * number_of_entries)))"
  if ((size > 500)); then
    size=500
  elif ((size < 244));then
    size=244
  fi

  printf "%d %d\n" "$size" "$size"
}

pick_connection() {
  readarray -t connections < <(
    nmcli -t -f TYPE,ACTIVE,NAME connection |
      grep -Ev "bridge|loopback"
  )

  number_of_connections="${#connections[@]}"

  if [[ "$number_of_connections" -eq 0 ]]; then
    notify-send "No connections available"
    exit 1
  fi

  read -r height width < <(get_menu_dimensions "$number_of_connections")

  connection="$(
    printf "%s\n" "${connections[@]}" |
      sed '
        s/^[^:]*://;
        s/yes\:/  /;s/no\://;
        s/^[a-zA-Z]/  &/' |
      rofi -dmenu -theme dmenu -theme-str \
        "window {width: ${width}px;height: ${height}px;}" \
        -p 'Toggle' -no-custom
  )" || exit 1

  echo "$connection"

}

main() {
  local connection
  local status
  connection_string="$(pick_connection)" || exit 1

  # Extract the status
  status="${connection_string%% *}"
  # Extract the connection name
  connection="${connection_string#*  }"

  if [ "$status" = "" ]; then
    nmcli connection up "$connection"
  elif [ "$status" = "" ]; then
    nmcli connection down "$connection"
  fi

}

main
